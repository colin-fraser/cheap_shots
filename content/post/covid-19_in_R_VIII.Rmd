---
title: "COVID-19 and R Part VIII"
author: "Drew Tyre"
date: "`r Sys.Date()`"
output:
  word_document: default
  html_document:
    code_folding: hide
draft: no
slug: COVID-19_and_R_VIII
tags_include:
- R
- OPD
- COVID19
categories: Research
og_image: /post/covid-19_in_r_viii_files/figure-html/featured_image-1.png
---

New cases in the USA took a big jump up yesterday. Italy continues to add more cases per day 
than 20 times their ICU capacity.

That outcome is not set in stone. The time to act is now. Even a one day delay in reducing transmission rate
dramatically increases the peak number of sick people. If you're lucky to be 
in a low risk group, you can still spread the virus. Although your symptoms are mild, 
the person you hand the virus off to could experience much worse symptoms. You don't 
have to hermetically seal your house. I like this graphic:
![social distancing suggestions](http://rutherfordcountytn.gov/img/2.png)

[This all started a week ago](/post/covid-19_and_r/), in case you're just joining.

# The bottom line

DISCLAIMER: These unofficial results are not peer reviewed, and should not be
treated as such. My goal is to learn about forecasting in real time, 
how simple models compare with more complex models, and even how to compare
different models. 

The figure below is complex, so I'll highlight some
features first. The y axis is now cases / 100,000 population to make it easier to compare Italy 
and the USA. As before, the BLUE LINES are exponential growth models that assume
the rate of increase is *constant*. The dashed black lines are predictions from that
model. To make comparison easier, the estimated model and predictions for both countries are on both panels.
The lines and intervals for the other country are faded out. The RED LINES
are 20 times the number of ICU beds per 100,000 population in each country. Note that
the y axis is logarithmic.

```{r base_image, warning=FALSE, message=FALSE, echo=FALSE}
library("tidyverse")
library("lubridate")
library("broom")
savefilename <- "data/jhu_wide_2020-03-20.Rda"

# jhu_url <- paste("https://raw.githubusercontent.com/CSSEGISandData/",
#                  "COVID-19/master/csse_covid_19_data/",
#                  "csse_covid_19_time_series/",
#                  "time_series_19-covid-Confirmed.csv", sep = "")
# 
# jhu_wide <- read_csv(jhu_url) # just grab it once from github
# # archive it!
# save(jhu_wide, file = savefilename)
load(savefilename)

country_data <- read_csv("data/countries_covid-19.csv") %>% 
  mutate(start_date = mdy(start_date))

source("R/jhu_helpers.R")

us_confirmed_total <- us_confirmed_long(jhu_wide) %>% 
  group_by(Date) %>% # then group by Date and sum
  summarize(cumulative_cases = sum(cumulative_cases)) %>% 
  ungroup() %>% 
  mutate(incident_cases = c(0, diff(cumulative_cases)),
         country_region = "USA",
         province = NA_character_) %>% 
  filter(Date > "2020-02-28")  # trim to first day after which all incident_cases > 0


us_exp_model <- us_confirmed_total %>% 
  mutate(log_incident_cases = log10(incident_cases),    # transform the data
         day = as.numeric(Date - ymd("2020-02-27"))) %>% # get day relative to Feb 27
  filter(Date > "2020-02-28", Date <= "2020-03-11") %>% 
  lm(data = .,
     formula = log_incident_cases ~ day) 

us_fits <- augment(us_exp_model, se_fit = TRUE) %>% 
    mutate(country_region = "USA",
           province = NA_character_,
           Date = ymd("2020-2-27") + day,
         lcl = 10^(.fitted - .se.fit*qt(0.975, df = 10)),
         ucl = 10^(.fitted + .se.fit*qt(0.975, df = 10)),
         fit = 10^.fitted)

predicted <- tibble(day = 14:27)
predicted_list <- predict(us_exp_model, newdata = predicted, se.fit = TRUE)
predicted$fit <- predicted_list$fit # this is klutzy, but I want to see the answer! 
predicted$se.fit <- predicted_list$se.fit
us_predicted <- predicted %>% 
  mutate(country_region = "USA",
           province = NA_character_,
         Date = ymd("2020-2-27") + day,
         pred_var = se.fit^2 + predicted_list$residual.scale^2,
         lpl = 10^(fit - sqrt(pred_var)*qt(0.975, df = 10)),
         upl = 10^(fit + sqrt(pred_var)*qt(0.975, df = 10)),
         fit = 10^fit)

# Take the wide format data and make it long
italy_confirmed <- other_confirmed_long(jhu_wide, countries = "Italy") %>% 
  # Calculate the number of new cases per day
  mutate(incident_cases = c(0, diff(cumulative_cases)))%>% 
  # only keep data after feb 21 when the outbreak started, and remove row with no reported cases
  filter(Date >= "2020-02-21", incident_cases > 0) 


# Fit the model to the first 12 days of data (to match what I did with USA)
italy_exp_model <- italy_confirmed %>% 
  filter(Date <= "2020-03-03") %>% 
  mutate(log_incident_cases = log10(incident_cases),
         day = as.numeric(Date - ymd("2020-02-21"))) %>% 
  lm(data = .,
     formula = log_incident_cases ~ day)
italy_fits <- augment(italy_exp_model, se_fit = TRUE) %>% 
    mutate(country_region = "Italy",
           province = NA_character_,
           Date = ymd("2020-2-21") + day,
         lcl = 10^(.fitted - .se.fit*qt(0.975, df = 10)),
         ucl = 10^(.fitted + .se.fit*qt(0.975, df = 10)),
         fit = 10^.fitted)
# Make predictions out to March 16
predicted <- tibble(day = 12:30)
predicted_list <- predict(italy_exp_model, newdata = predicted, se.fit = TRUE)
italy_predicted <- predicted %>% 
  mutate(country_region = "Italy",
           province = NA_character_,
         Date = ymd("2020-02-21") + day,
         fit = predicted_list$fit,
         se.fit = predicted_list$se.fit,
         pred_var = se.fit^2 + predicted_list$residual.scale^2,
         lpl = 10^(fit - sqrt(pred_var)*qt(0.975, df = 10)),
         upl = 10^(fit + sqrt(pred_var)*qt(0.975, df = 10)),
         fit = 10^fit)




observed <- bind_rows(us_confirmed_total, italy_confirmed) %>% 
  left_join(country_data) %>% 
  mutate(icpc = incident_cases * 10 / popn,
         group = country_region)
fits <- bind_rows(USA = us_fits, Italy = italy_fits)%>% 
  left_join(country_data)%>% 
  mutate(fitpc = fit * 10 / popn,
         lclpc = lcl * 10 / popn,
         uclpc = ucl * 10 / popn,
         group = country_region)
predicted <- bind_rows(USA = us_predicted, Italy = italy_predicted)%>% 
  left_join(country_data)%>% 
  mutate(fitpc = fit * 10 / popn,
         lplpc = lpl * 10 / popn,
         uplpc = upl * 10 / popn,
         group = country_region)

ggplot(data = observed,
       mapping = aes(x = Date)) + 
  geom_point(mapping = aes(y = icpc, color = group)) + 
  facet_wrap(~country_region, scales = "free_x") +
  scale_y_log10() +
  geom_line(data = select(fits, -country_region),
            mapping = aes(y = fitpc, color = group),
            alpha = 0.5) +
  geom_ribbon(data = select(fits, -country_region),
            mapping = aes(ymin = lclpc, ymax = uclpc, group = group),
            alpha = 0.1) +
  geom_line(data = select(predicted, -country_region),
            mapping = aes(y = fitpc, color = group),
            linetype = 2, alpha = 0.5) +
  geom_ribbon(data = select(predicted, -country_region),
            mapping = aes(ymin = lplpc, ymax = uplpc, group = group),
            alpha = 0.1) +
  geom_line(data = fits,
            mapping = aes(y = fitpc, color = group),
           size = 1.25) +
  geom_ribbon(data = fits,
            mapping = aes(ymin = lclpc, ymax = uclpc),
            alpha = 0.2) +
  geom_line(data = predicted,
            mapping = aes(y = fitpc, color = group),
            linetype = 2) +
  geom_ribbon(data = predicted,
            mapping = aes(ymin = lplpc, ymax = uplpc),
            alpha = 0.2) +
  geom_hline(mapping = aes(yintercept = icu_beds/0.05), color = "red", linetype = 2) +
  labs(y = "Incident cases per 100,000 population", title = "New reported cases per day",
       subtitle = "Solid line: exponential model; Dashed line: forecast cases with 95% prediction intervals.",
       caption = paste("Source data: https://github.com/CSSEGISandData/COVID-19 downloaded ",
                       format(file.mtime(savefilename), usetz = TRUE),
                       "\n Unofficial, not peer reviewed results.",
                       "\n Copyright Andrew Tyre 2020. Distributed with MIT License.")) + 
  geom_text(mapping = aes(y = 1.3*icu_beds/0.05), 
            x = ymd("2020-02-21"),
           label = "20 x # ICU beds / 100K",
           size = 2.5, hjust = "left") +
  theme(legend.position = "none")
```

[Unlike yesterday](/post/covid-19_and_r_vii/), new cases in the USA took a big jump up, but are still inside the prediction interval[^1]. 
Italy's numbers continue the linear pattern that started around March 12 -- they are going along at a constant
level, a flat line on this graph. Each day Italy adds about the same number of cases as 
the day before. Unfortunately that is still more cases per day than their health care infrastructure can
handle. 

Below are the same calculations but focused in on 3 US states and 3 Canadian provinces[^2].
Each panel has the same features as the graph above.

```{r featured_image, message=FALSE, echo = FALSE}
us_by_state <- us_confirmed_long(jhu_wide) # see, fancy! 
canada_by_prov <- other_confirmed_long(jhu_wide, countries = "Canada")
all_by_province <- bind_rows(us_by_state, canada_by_prov) %>% 
  left_join(country_data) %>% 
  group_by(country_region, province) %>% 
  mutate(incident_cases = c(0, diff(cumulative_cases)),
         max_cases = max(cumulative_cases)) %>% 
  ungroup() %>% 
  mutate(icpc = incident_cases * 10 / popn,
         group = as.numeric(factor(country_region))) %>% 
  # remove early rows from each state/province
  # remove 0 rows in the middle that are probably reporting errors
  filter(incident_cases > 0, Date >= start_date,
         province %in% c("California", "Washington", "New York", "British Columbia", "Alberta", "Ontario")) %>% 
  mutate(province = factor(province, levels = c("California", "Washington", "New York", "British Columbia", "Alberta", "Ontario")))


# fit the models
all_models <- all_by_province %>% 
  mutate(log10_ic = log10(incident_cases),
         day = as.numeric(Date - start_date)) %>% 
  filter(day <= 12) %>% 
  group_by(province) %>% 
  nest() %>% 
    mutate(model = map(data, ~lm(log10_ic~day, data = .)))

all_fit <- all_models %>% 
  mutate(fit = map(model, augment, se_fit = TRUE),
         fit = map(fit, select, -c("log10_ic","day"))) %>% 
  select(-model) %>% 
  unnest(cols = c("data","fit")) %>% 
  mutate(fit = 10^.fitted,
         lcl = 10^(.fitted - .se.fit * qt(0.975, df = 10)),
         ucl = 10^(.fitted + .se.fit * qt(0.975, df = 10)),
    fitpc = fit * 10 / popn,
         lclpc = lcl * 10 / popn,
         uclpc = ucl * 10 / popn)

all_predicted <- all_by_province %>% 
    mutate(day = as.numeric(Date - start_date)) %>% 
  filter(day > 12) %>% #these are the rows we want to predict with
  group_by(province) %>% 
  nest() %>% 
  left_join(select(all_models, province, model), by="province") %>% 
  mutate(predicted = map2(model, data, ~augment(.x, newdata = .y, se_fit = TRUE)),
         sigma = map_dbl(model, ~summary(.x)$sigma)) %>% 
  select(-c(model,data)) %>% 
  unnest(cols = predicted) %>% 
  mutate(
    fit = 10^.fitted,
    pred_var = sigma^2 + .se.fit^2,
    lpl = 10^(.fitted - sqrt(pred_var)*qt(0.975, df = 10)),
    upl = 10^(.fitted + sqrt(pred_var)*qt(0.975, df = 10)),
    fitpc = fit * 10 / popn,
         lplpc = lpl * 10 / popn,
         uplpc = upl * 10 / popn)

ggplot(data = all_by_province,
                    mapping = aes(x = Date)) + 
  geom_point(mapping = aes(y = icpc, color = province)) + 
  facet_wrap(~province, dir="v") + 
  scale_y_log10() + 
  theme(legend.position = "none") + 
  geom_line(data = all_fit,
            mapping = aes(y = fitpc, color = province),
            size = 1.25) +
  geom_ribbon(data = all_fit,
            mapping = aes(ymin = lclpc, ymax = uclpc),
            alpha = 0.2) +
  geom_line(data = all_predicted,
            mapping = aes(y = fitpc, color = province),
            linetype = 2) +
  geom_ribbon(data = all_predicted,
            mapping = aes(ymin = lplpc, ymax = uplpc),
            alpha = 0.2)  +
  geom_hline(mapping = aes(yintercept = icu_beds/0.05), color = "red", linetype = 3) +
  labs(y = "Incident cases per 100,000 population", title = "New reported cases per day",
       subtitle = "Solid line: exponential model; Dashed line: forecast cases with 95% prediction intervals.",
       caption = paste("Source data: https://github.com/CSSEGISandData/COVID-19 downloaded ",
                       format(file.mtime(savefilename), usetz = TRUE),
                       "\n Unofficial, not peer reviewed results.",
                       "\n Copyright Andrew Tyre 2020. Distributed with MIT License.") +  
  geom_text(
            mapping = aes(y = 1.3*icu_beds/0.05), 
            x = ymd("2020-03-01"),
           label = "20 x # ICU beds / 100K",
           size = 2.5, hjust = "left")
       ) 
  

```

# Full data nerd past here

Remember -- coding while thinking, no coherent story, ymmv. 


# What's next?

So tomorrow I should be able to fiddle the state/province graphs a bit more
and get localized predictions for when ICU capacity might become a problem. I guess
it's getting time to find an alternative model to the exponential as well. The 
logistic curves from a few days ago were terrible at forecasting, so not sure
what else to try. Suggestions in the comments please! 

I'd also like to refine the prediction of ICU capacity. [I finally found someone
making predictions that include confidence limits](https://medium.com/@megan.higgie/without-serious-action-australia-will-run-out-of-intensive-care-beds-between-7-and-10-april-59f83b52756e) and Dr. Higgie predicts the time at which Australia
will start to experience issues with ICU capacity (early April). She makes a great point that 
cases occupy an ICU bed for some weeks, so just looking at the new cases is optimistic. Instead
there needs to be a kind of sliding window sum of the new cases. 







[^1]: Code not shown in the post can be found [on Github](https://raw.githubusercontent.com/rbind/cheap_shots/master/content/post/covid-19_in_R_VII.Rmd).
This post benefited from comments by Ramona Sky, Kelly Helm-Smith, and Jessica Burnett.

[^2]: Full disclosure: I'm Canadian!